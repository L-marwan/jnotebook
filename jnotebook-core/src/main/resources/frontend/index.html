<!--

    Copyright Cyril de Catheu, 2023

    Licensed under the JNOTEBOOK LICENSE 1.0 (the "License"); you may not use
    this file except in compliance with the License. You may obtain a copy of the
    License at https://raw.githubusercontent.com/cyrilou242/jnotebook/main/LICENSE

    Unless required by applicable law or agreed to in writing, software distributed under the
    License is distributed on an "AS IS" BASIS, WITHOUT * WARRANTIES OF ANY KIND,
    either express or implied.
    See the License for the specific language governing permissions and limitations under
    the License.

-->
<!DOCTYPE html>
<html lang="en" class="overflow-hidden min-h-screen">
<head>
    <meta charset="UTF-8"/>
    <meta http-equiv="X-UA-Compatible" content="IE=edge"/>
    <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
    <title>Notebook</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.16.4/dist/katex.min.css"
          integrity="sha384-vKruj+a13U8yHIkAyGgK1J3ArTLzrFGBbBc0tDp4ad/EyewESeXE/Iv67Aj8gKZ0" crossorigin="anonymous">
    <script defer src="https://cdn.jsdelivr.net/npm/katex@0.16.4/dist/katex.min.js"
            integrity="sha384-PwRUT/YqbnEjkZO0zZxNqcxACrXe+j766U2amXcgMg5457rve2Y7I6ZJSm2A0mS4"
            crossorigin="anonymous"></script>
    <script defer src="https://cdn.jsdelivr.net/npm/katex@0.16.4/dist/contrib/auto-render.min.js"
            integrity="sha384-+VBxd3r6XgURycqtZ117nYw44OOcIax56Z4dCRWbxyPt0Koah1uHoK0o4+/RRE05" crossorigin="anonymous"
            onload="renderMathInElement(document.body);"></script>
    <script defer src="https://cdn.jsdelivr.net/npm/mermaid/dist/mermaid.min.js"
            onload="mermaid.initialize({startOnLoad:true});"></script>
    <script src="https://cdn.jsdelivr.net/npm/vega@5"></script>
    <script src="https://cdn.jsdelivr.net/npm/vega-lite@5"></script>
    <script src="https://cdn.jsdelivr.net/npm/vega-embed@6"></script>
    <script src="https://cdn.plot.ly/plotly-latest.min.js"></script>
    <link rel="stylesheet" href="//cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/styles/default.min.css">
    <script src="//cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/highlight.min.js"></script>
    <link rel="stylesheet" type="text/css"
          href="https://cdn.jsdelivr.net/npm/d3-flame-graph@4.1.3/dist/d3-flamegraph.css">
    <script type="text/javascript" src="https://d3js.org/d3.v7.js"></script>
    <script type="text/javascript"
            src="https://cdn.jsdelivr.net/npm/d3-flame-graph@4.1.3/dist/d3-flamegraph.min.js"></script>
    <script src="https://cdn.tailwindcss.com?plugins=typography"></script>
    <script>tailwind.config = {
        darkMode: "class",
        content: ["./tw/viewer.js", "./tw/**/*.edn"],
        safelist: ['dark'],
        theme: {
            extend: {},
            fontFamily: {
                sans: ["Fira Sans", "-apple-system", "BlinkMacSystemFont", "sans-serif"],
                serif: ["PT Serif", "serif"],
                mono: ["Fira Mono", "monospace"]
            }
        },
        variants: {
            extend: {},
        },
        plugins: [],
    }</script>
    <style type="text/tailwindcss">@tailwind base;
    @tailwind components;
    @tailwind utilities;

    @layer base {
        html {
            font-size: 18px;
        }

        @media (max-width: 600px) {
            html {
                font-size: 16px;
            }
        }
        .font-condensed {
            font-family: "Fira Sans Condensed", sans-serif;
        }

        .font-inter {
            font-family: "Inter", sans-serif;
        }

        body {
            @apply font-serif antialiased text-gray-900 sm:overscroll-y-none;
        }

        code, .code {
            @apply font-mono text-sm text-gray-900 bg-slate-50 px-0.5 py-px rounded dark:bg-gray-800;
        }

        code::before, code::after {
            @apply content-none !important;
        }

        h1, h3, h4, h5, h6 {
            @apply font-condensed font-bold mt-8 first:mt-0;
        }

        h2 {
            /*We cannot collapse margins due to nesting but we want to*/
            /*keep the h2’s large margin visible*/
            @apply font-condensed font-bold mt-8 first:mt-2;
        }

        h1 {
            @apply text-4xl;
        }

        h2 {
            @apply text-3xl;
        }

        h3 {
            @apply text-2xl;
        }

        button {
            @apply focus:outline-none;
        }

        strong {
            @apply font-bold;
        }

        em {
            @apply italic;
        }

        pre {
            @apply m-0 font-mono;
        }
    }

    /* Compatibility */
    /* --------------------------------------------------------------- */
    /* TODO: Verify which colors are in use and replace with Tailwind
       colors accordingly. Move Nj-specific styles out of here. */

    :root {
        --teal-color: #31afd0;
        --dark-teal-color: #095960;
        --near-black-color: #2e2e2c;
        --red-color: #d64242;
        --dark-blue-color: #1f2937;
        --dark-blue-60-color: rgba(28, 42, 56, 0.6);
        --gray-panel-color: rgba(239, 241, 245, 1.000);
        --brand-color: var(--dark-blue-color);
        --link-color: #5046e4;
        --command-bar-selected-color: var(--teal-color);
    }

    .serif {
        @apply font-serif;
    }

    .sans-serif {
        @apply font-sans;
    }

    .monospace {
        @apply font-mono;
    }

    .inter {
        @apply font-inter;
    }

    .border-color-teal {
        border-color: var(--dark-teal-color);
    }

    .teal {
        color: var(--teal-color);
    }

    .bg-dark-blue {
        background: var(--dark-blue-color);
    }

    .bg-dark-blue-60 {
        background: rgba(28, 42, 56, 0.6);
    }

    .bg-gray-panel {
        background: var(--gray-panel-color);
    }

    .text-dark-blue {
        color: var(--dark-blue-color);
    }

    .text-dark-blue-60 {
        color: var(--dark-blue-60-color);
    }

    .border-dark-blue-30 {
        border-color: rgba(28, 42, 56, 0.6);
    }

    .text-brand {
        color: var(--dark-blue-color);
    }

    .bg-brand {
        background: var(--dark-blue-color);
    }

    .text-selected {
        color: white;
    }

    .red {
        color: var(--red-color);
    }

    /* Disclose Button */
    /* --------------------------------------------------------------- */

    .disclose {
        @apply content-none border-solid cursor-pointer inline-block relative mr-[3px] top-[-2px] transition-all;
        border-color: var(--near-black-color) transparent;
        border-width: 6px 4px 0;
    }

    .disclose:hover {
        border-color: var(--near-black-color) transparent;
    }

    .dark .disclose,
    .dark .disclose:hover {
        border-color: white transparent;
    }

    .disclose.collapsed {
        @apply rotate-[-90deg];
    }

    /* Layout */
    /* --------------------------------------------------------------- */

    .page {
        @apply max-w-5xl mx-auto px-12 box-border flex-shrink-0;
    }

    .max-w-prose {
        @apply max-w-[46rem] !important;
    }

    .max-w-wide {
        @apply max-w-3xl !important;
    }

    /* List Styles */
    /* --------------------------------------------------------------- */

    .task-list-item + .task-list-item,
    .viewer-markdown ul ul {
        @apply mt-1 mb-0;
    }

    /* compact TOC */
    .viewer-markdown .toc ul {
        list-style: none;
        @apply my-1;
    }

    /* Code Viewer */
    /* --------------------------------------------------------------- */

    .viewer-code {
        @apply font-mono bg-slate-100 rounded-sm text-sm overflow-x-auto dark:bg-gray-800;
    }

    .viewer-code .cm-content {
        @apply py-4 px-8;
    }

    @media (min-width: 960px) {
        .viewer-notebook .viewer-code .cm-content {
            @apply py-4 pl-12;
        }
    }

    /* Don’t show focus outline when double-clicking cell in Safari */
    .cm-scroller {
        @apply focus:outline-none;
    }

    /* Syntax Highlighting */
    /* --------------------------------------------------------------- */

    .inspected-value {
        @apply text-xs font-mono leading-[1.25rem];
    }

    .result-data {
        @apply font-mono text-sm overflow-x-auto whitespace-nowrap leading-normal;
    }

    .result-data::-webkit-scrollbar, .path-nav::-webkit-scrollbar {
        @apply h-0;
    }

    .result-data-collapsed {
        @apply whitespace-nowrap;
    }

    .result-data-field {
        @apply ml-4 whitespace-nowrap;
    }

    .result-data-field-link {
        @apply ml-4 whitespace-nowrap cursor-pointer;
    }

    .result-data-field-link:hover {
        @apply text-black bg-black/5;
    }

    .result-text-empty {
        color: rgba(0, 0, 0, .3);
    }

    .browsify-button:hover {
        box-shadow: -2px 0 0 2px #edf2f7;
    }

    /* Prose */
    /* --------------------------------------------------------------- */

    .viewer-notebook,
    .viewer-markdown {
        @apply prose
        dark:prose-invert
        prose-a:text-blue-600 prose-a:no-underline hover:prose-a:underline
        dark:prose-a:text-blue-300
        prose-p:mt-4 prose-p:leading-snug
        prose-ol:mt-4 prose-ol:mb-6 prose-ol:leading-snug
        prose-ul:mt-4 prose-ul:mb-6 prose-ul:leading-snug
        prose-blockquote:mt-4 prose-blockquote:leading-snug
        prose-hr:mt-6 prose-hr:border-t-2 prose-hr:border-solid prose-hr:border-slate-200
        prose-figure:mt-4
        prose-figcaption:mt-2 prose-figcaption:text-xs
        prose-headings:mb-4
        prose-table:mt-0
        prose-th:mb-0
        prose-img:my-0
        prose-code:font-medium prose-code:bg-slate-100
        max-w-none;
    }

    .viewer-markdown blockquote p:first-of-type:before,
    .viewer-markdown blockquote p:last-of-type:after {
        @apply content-none;
    }

    /* Images */
    /* --------------------------------------------------------------- */


    /* Todo Lists */
    /* --------------------------------------------------------------- */

    .contains-task-list {
        @apply pl-6 list-none;
    }

    .contains-task-list input[type="checkbox"] {
        @apply appearance-none h-4 w-4 rounded border border-slate-200 relative mr-[0.3rem] ml-[-1.5rem] top-[0.15rem];
    }

    .contains-task-list input[type="checkbox"]:checked {
        @apply border-indigo-600 bg-indigo-600 bg-no-repeat bg-contain;
        background-image: url("data:image/svg+xml,%3csvg viewBox='0 0 16 16' fill='white' xmlns='http://www.w3.org/2000/svg'%3e%3cpath d='M12.207 4.793a1 1 0 010 1.414l-5 5a1 1 0 01-1.414 0l-2-2a1 1 0 011.414-1.414L6.5 9.086l4.293-4.293a1 1 0 011.414 0z'/%3e%3c/svg%3e");
    }

    /* Markdown TOC */
    /* --------------------------------------------------------------- */

    .viewer-markdown .toc {
        @apply mt-4;
    }

    .viewer-markdown h1 + .toc {
        @apply mt-8;
    }

    .viewer-markdown .toc h1,
    .viewer-markdown .toc h2,
    .viewer-markdown .toc h3,
    .viewer-markdown .toc h4,
    .viewer-markdown .toc h5,
    .viewer-markdown .toc h6 {
        @apply text-base text-indigo-600 font-sans my-0;
    }

    .viewer-markdown .toc a {
        @apply text-indigo-600 font-normal no-underline hover:underline;
    }

    .viewer-markdown .toc li {
        @apply m-0;
    }

    .viewer-markdown .toc ul ul {
        @apply pl-4;
    }

    /* Notebook Spacing */
    /* --------------------------------------------------------------- */

    .viewer-notebook {
        @apply py-16;
    }

    #clerk-static-app .viewer-notebook {
        @apply pt-[0.8rem] pb-16;
    }

    .viewer-markdown *:first-child:not(.viewer-code):not(li):not(h2) {
        @apply mt-0;
    }

    /*.viewer + .viewer { @apply mt-6; }*/
    .viewer + .viewer-result {
        @apply mt-0;
    }

    .viewer-code + .viewer-result {
        @apply mt-3;
    }

    .viewer-markdown + .viewer-markdown {
        @apply mt-0;
    }

    /* Sidenotes */
    /* --------------------------------------------------------------- */

    .sidenote-ref {
        @apply top-[-3px] inline-flex justify-center items-center w-[18px] h-[18px]
        rounded-full bg-slate-100 border border-slate-300 hover:bg-slate-200 hover:border-slate-300
        m-0 ml-[4px] cursor-pointer;
    }

    .sidenote {
        @apply hidden float-left clear-both mx-[2.5%] my-4 text-xs relative w-[95%];
    }

    .sidenote-ref.expanded + .sidenote {
        @apply block;
    }

    @media (min-width: 860px) {
        .sidenote-ref {
            @apply top-[-0.5em] w-auto h-auto inline border-0 bg-transparent m-0 pointer-events-none;
        }

        .sidenote sup {
            @apply inline;
        }

        .viewer-markdown .contains-sidenotes p {
            @apply max-w-[65%];
        }

        .viewer-markdown p .sidenote {
            @apply mr-[-54%] mt-[0.2rem] w-1/2 float-right clear-right relative block;
        }
    }

    .viewer-code + .viewer:not(.viewer-markdown):not(.viewer-code):not(.viewer-code-folded),
    .viewer-code-folded + .viewer:not(.viewer-markdown):not(.viewer-code):not(.viewer-code-folded),
    .viewer-result + .viewer-result {
        @apply mt-2;
    }

    .viewer-code + .viewer-code-folded {
        @apply mt-4;
    }

    .viewer-result {
        @apply leading-tight mb-6;
    }

    .viewer-result figure {
        @apply mt-0 !important;
    }

    @media (min-width: 768px) {
        .devcard-desc > div {
            @apply max-w-full m-0;
        }
    }

    /* Command Palette */
    /* --------------------------------------------------------------- */

    .nj-commands-input {
        @apply bg-transparent text-white;
    }

    .nj-context-menu-item:hover:not([disabled]) {
        @apply cursor-pointer;
        background-color: rgba(255, 255, 255, .14);
    }

    /* Devdocs */
    /* --------------------------------------------------------------- */

    .logo, .logo-white {
        @apply block indent-[-999em];
        background: url(/images/nextjournal-logo.svg) center center no-repeat;
    }

    .devdocs-body {
        @apply font-inter;
    }

    /* Workarounds */
    /* --------------------------------------------------------------- */

    /* Fixes vega viewer resizing into infinity */
    .vega-embed .chart-wrapper {
        @apply h-auto !important;
    }

    /* fixes fraction separators being overridden by tw’s border-color */
    .katex * {
        @apply border-black;
    }

    /* end of fork */
    .hljs {
        background-color: transparent !important;
    }

    .cm-success {
        position: relative;
    }

    .cm-success::after {
        content: '';
        position: absolute;
        bottom: 5px;
        right: 5px;
        width: 24px;
        height: 24px;
        background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' fill='none' viewBox='0 0 24 24' stroke-width='1.5' stroke='currentColor' class='w-6 h-6'%3E%3Cpath stroke-linecap='round' stroke-linejoin='round' d='M9 12.75L11.25 15 15 9.75M21 12a9 9 0 11-18 0 9 9 0 0118 0z'/%3E%3C/svg%3E");
    }

    .cm-failure {
        position: relative;
    }

    .cm-failure::after {
        content: '';
        position: absolute;
        bottom: 5px;
        right: 5px;
        width: 24px;
        height: 24px;
        background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 20 20' fill='currentColor' style='width: 100%; height: 100%;'%3E%3Cpath fill-rule='evenodd' d='M8.485 2.495c.673-1.167 2.357-1.167 3.03 0l6.28 10.875c.673 1.167-.17 2.625-1.516 2.625H3.72c-1.347 0-2.189-1.458-1.515-2.625L8.485 2.495zM10 5a.75.75 0 01.75.75v3.5a.75.75 0 01-1.5 0v-3.5A.75.75 0 0110 5zm0 9a1 1 0 100-2 1 1 0 000 2z' clip-rule='evenodd'/%3E%3C/svg%3E");
    }

    .result-error {
        background-color: #ffe4e4;
    }

    </style>
</head>
<body class="dark:bg-gray-900">
<div class="flex">
    <div class="fixed top-2 left-2 md:left-auto md:right-2 z-10"></div>
    <div class="flex-auto h-screen overflow-y-auto scroll-container">
        <div id="notebook" class="flex flex-col items-center viewer-notebook flex-auto">
            <div id="helper" class="viewer viewer-result w-full max-w-prose px-8">
                <div class="relative">
                    <div class="overflow-y-hidden">
                        <p>Save a file in your <code>[[${config.notebookPath}]]</code> folder to make your notebook
                            appear…</p></div>
                </div>
            </div>
        </div>
    </div>
    <script th:inline="javascript">
        function update(eventData) {
            document.getElementById("notebook").innerHTML = eventData;
            // render mermaid
            mermaid.init({noteMargin: 10}, '.mermaid');

            // render latex
            var mathElems = document.getElementsByClassName("katex");
            var elems = [];
            for (const i in mathElems) {
                if (mathElems.hasOwnProperty(i)) elems.push(mathElems[i]);
            }
            elems.forEach(elem => {
                katex.render(elem.textContent, elem, {throwOnError: false, displayMode: elem.nodeName !== 'SPAN',});
            });

            // render code color
            document.querySelectorAll('div.cm-content').forEach(el => {
                hljs.highlightElement(el, {language: 'java'});
            });

            // render vega
            document.querySelectorAll('div.vega-embed').forEach(el => {
                vegaEmbed(el, JSON.parse(el.dataset.config))
            });

            // render plotly
            document.querySelectorAll('div.js-plotly-plot').forEach(el => {
                Plotly.newPlot(el, JSON.parse(el.dataset.data), JSON.parse(el.dataset.layout), JSON.parse(el.dataset.config));
            });

            // render flamegraphs
            document.querySelectorAll(".flame").forEach(el => {
                const chart = flamegraph().inverted(true).width(el.parentElement.offsetWidth);
                d3.select(el).datum(JSON.parse(el.dataset.profile)).call(chart);
            })
        }

        function startWebSocketServer() {
            var port = [[${config.port}]];
            var socket = new WebSocket("ws://localhost:" + port + "/websocket");

            socket.onclose = function (event) {
                console.log("Websocket connection closed or unable to connect; " +
                    "starting reconnect timeout");
                socket = null;
                setTimeout(function () {startWebSocketServer();}, 5000)
            }

            socket.onmessage = (socketEvent)  => {
                if (socketEvent.data.startsWith("exampleKeyword")) {
                    //do something - not useful anymore but keeping the pattern

                } else {
                    update(socketEvent.data);
                }
            };
        }

        startWebSocketServer();
    </script>
</div>
</body>
</html>
